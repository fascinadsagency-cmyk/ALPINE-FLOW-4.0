<analysis>**original_problem_statement:**
Crear un sistema de gestión completo para tiendas de alquiler de equipos de esquí/snowboard. El sistema debe priorizar la velocidad y la precisión.

**PRODUCT REQUIREMENTS (Consolidated & Updated):**
1.  **Gestión Central:** Alquileres, Devoluciones, Inventario (con código interno manual), Clientes (con historial financiero), Proveedores, Tarifas.
2.  **Módulos Financieros:**
    *   **Dashboard Estratégico:** Con calendario de ocupación, rankings de rendimiento, y un nuevo panel de Control de Devoluciones.
    *   **Gestión de Caja:** Con arqueo manual detallado, historial, y posibilidad de revertir cierres. Debe registrar y sincronizar todos los movimientos y permitir múltiples turnos/sesiones por día.
    *   **Reportes Flexibles:** Con filtro por rango, botones de selección rápida y comparativa interanual.
    *   **Rentabilidad de Inventario:** Trackear coste, ingresos, amortización y beneficio neto por artículo.
3.  **Flujos de Trabajo Optimizados:**
    *   **Apertura de Caja Manual:** La caja se abre desde su propio módulo. No se debe intentar abrir automáticamente al cobrar.
    *   **Pasarela de Pago en Alquiler:** Un modal de pago (Efectivo/Tarjeta) asegura el registro del cobro.
    *   **Devolución Rápida:** Botón de un solo clic para cerrar alquileres.
    *   **Modificar Duración:** Permitir ampliar/acortar alquileres activos con ajuste financiero.
    *   **Tipos de Artículo 100% Personalizados:** El usuario crea y gestiona todas las categorías de inventario.
    *   **Buscador de Clientes Avanzado:** Implementar buscador por nombre/DNI/teléfono con autocompletado.
    *   **Artículos Genéricos (por Cantidad):** Gestionar ítems como 'Cascos' por stock total en vez de por código de barras individual.
    *   **Añadido Rápido:** Botones para añadir rápidamente ítems genéricos como Cascos, Bastones y Máscara.
4.  **Sistema de Tickets/Comprobantes:** Impresión como comprobante de un pago ya realizado.
5.  **Gestión de Datos:**
    *   **Importador Universal (CSV/Excel):** Para clientes e inventario.
    *   **Ficha de Artículo Ampliada:** Añadir campos 'Fijación' y 'Número de Serie'.
    *   **Personalización de Tablas:** Permitir reordenar y ocultar columnas en la tabla de inventario.
6.  **Soporte y Personalizaciones:** Pestaña para que el usuario pueda abrir tickets de soporte.
7.  **Integraciones Futuras:** VeriFactu, WhatsApp, TPV, Email, Google Calendar.

**User's preferred language**: Spanish

**what currently exists?**
Es un sistema full-stack (React, FastAPI, MongoDB) para la gestión de alquileres de esquí. En la última sesión, se implementaron varias características y se corrigieron numerosos errores, principalmente en los módulos de  y .

**Funcionalidades Clave:**
-   **Artículos Genéricos:** Se implementó un sistema para gestionar artículos por cantidad (stock) en lugar de por código de barras individual. Esto incluye un nuevo formulario en el inventario y lógica de backend para descontar/devolver unidades del stock.
-   **Tipos de Artículo 100% Personalizables:** Se eliminaron todas las categorías de artículos predefinidas (hardcoded). Ahora, el usuario tiene control total para crear y eliminar sus propias categorías desde la interfaz. Se ejecutó una migración para mover los artículos existentes a este nuevo sistema.
-   **Botonera de Añadido Rápido:** En la pantalla de , se añadieron tres botones fijos (, , ) para añadir rápidamente artículos genéricos al carrito. La lógica ahora incrementa la cantidad (, ) en lugar de añadir líneas duplicadas.
-   **Edición de Precios en Carrito:** Se corrigió y validó la funcionalidad que permite editar el precio de un artículo directamente en la lista del alquiler, con recálculo automático del total.
-   **Eliminación de Precios Legacy:** Se eliminó por completo el antiguo sistema de precios simples, forzando al sistema a usar exclusivamente las tarifas por días.
-   **Flujo de Cobro Simplificado (Bypass):** Tras repetidos errores críticos de servidor al intentar abrir la caja y cobrar en un solo paso, se implementó una solución de bypass. Ahora, el sistema no intenta abrir la caja automáticamente. Si la caja está cerrada, muestra un aviso para que el usuario la abra manualmente desde el módulo  antes de poder cobrar.

**Last working item**:
-   **Last item agent was working**: El agente acababa de recibir un informe de error crítico del usuario: **El arqueo de caja sale a cero porque los cobros de Nuevo Alquiler no se están sumando al saldo de la caja activa.** El agente estaba a punto de empezar a investigar la causa raíz de este fallo contable.
-   **Status**: NOT STARTED
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: both
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: (P0) **Los cobros de alquiler no se registran en la caja.**
    -   **Description**: Al completar un alquiler y procesar el pago, no se está creando el  correspondiente o no se está vinculando a la  activa. Esto provoca que el arqueo de caja no refleje los ingresos, un error contable crítico.
    -   **Next debug checklist**:
        1.  Revisar la función  en .
        2.  Verificar que, tras un alquiler exitoso, se realiza una llamada al backend para registrar un .
        3.  Asegurarse de que el  de la caja activa se obtiene correctamente y se incluye en la petición.
        4.  Revisar el endpoint del backend ( o similar) para confirmar que guarda el movimiento y lo asocia a la sesión.
    -   **Why fix this issue and what will be achieved with the fix?**: Es la funcionalidad más crítica del módulo de caja. Sin esto, el sistema no puede realizar un seguimiento de los ingresos y es contablemente inútil.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y (Es un síntoma del problema de sincronización omnicanal no resuelto).
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None. Este es el bloqueador principal.
-   **Issue 2**: (P2) **Fragilidad de la arquitectura del backend.**
    -   **Description**: El archivo  es un monolito que sigue creciendo, aumentando el riesgo de introducir errores de sintaxis o indentación que detienen el servicio.
    -   **Next debug checklist**: La solución a largo plazo es una refactorización modular. A corto plazo, cualquier edición debe ser seguida por una revisión cuidadosa y una verificación de los logs del supervisor.
    -   **Why fix this issue and what will be achieved with the fix?**: La refactorización es crucial para la estabilidad y mantenibilidad del proyecto. Reducirá el tiempo de depuración y facilitará la adición de nuevas funcionalidades.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   **Task 1**: (P1) Sincronización completa de caja (Omnicanalidad).
    -   **Description**: El agente solo ha intentado (y ahora está roto) sincronizar los nuevos alquileres con la caja. Otras operaciones financieras (Taller, devoluciones, gastos) siguen sin vincularse a la sesión de caja activa. El error P0 actual es una manifestación directa de esta tarea incompleta.
    -   **Where to resume**: Revisar todos los endpoints en  que crean  (ej: , ) y asegurarse de que obtienen y asignan el  de la sesión activa, lanzando un error si no hay ninguna.
    -   **What will be achieved with this?**: La pestaña de caja será un reflejo 100% fiel de toda la actividad financiera del negocio.
    -   **Status**: IN PROGRESS (Partially Done & Broken)
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on something**: La resolución del Issue 1 es el primer paso de esta tarea.
-   **Task 2**: (P2) Implementar personalización de la tabla de Inventario (Drag & Drop).
    -   **Description**: Permitir al usuario reordenar las columnas de la tabla de inventario mediante drag and drop y seleccionar su visibilidad.
    -   **Where to resume**: La dependencia  está instalada. El trabajo en  fue pausado y debe reanudarse.
    -   **What will be achieved with this?**: Ofrecerá una experiencia de usuario altamente personalizada.
    -   **Status**: IN PROGRESS (Paused)
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on something**: Tareas de caja son más prioritarias.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P2) **Crear Pestaña de Soporte y Mejoras:** Crear una nueva página con un formulario para que el usuario pueda solicitar nuevas funcionalidades o reportar problemas.
    -   (P2) **Finalizar Sistema de Impresión:** Implementar el interruptor Impresión Automática en  y conectar su estado a los flujos de trabajo.
    -   (P2) **Refresco en tiempo real (Polling):** Evaluar añadir polling a páginas clave como el Dashboard para que los datos se actualicen automáticamente.
-   **Future Tasks:**
    -   Integraciones (VeriFactu, WhatsApp API, TPV, Email, Google Calendar).
    -   Sistema de Reservas Online.
    -   Modo Oscuro.

**Completed work in this session**
-   **Feature: Artículos Genéricos:** Implementado sistema para gestionar inventario por cantidad de stock.
-   **Feature: Purga de Tipos de Artículo:** Eliminados todos los tipos predefinidos; ahora son 100% gestionados por el usuario.
-   **Feature: Botonera de Añadido Rápido:** Rediseñada para añadir ítems genéricos e incrementar su cantidad.
-   **Feature: Eliminación de Precios Legacy:** El sistema ahora usa exclusivamente tarifas por días.
-   **Bugfix: Edición de Precios en Carrito:** Corregida y validada.
-   **Bugfix: Flujo de Cobro Simplificado:** Implementado un bypass para evitar errores de servidor, desacoplando la apertura de caja del cobro.
-   **Bugfix: Múltiples errores de UI y de Validación:** Corregidos errores de renderizado en React, errores de validación 422 de FastAPI y fallos de parsing de datos.
-   **Feature Restoration:** Recuperada la visualización de Packs/Combos en la pantalla de .

**Earlier issues found/mentioned but not fixed**
-   El problema de la **sincronización omnicanal** (Tarea en Progreso 1) fue identificado pero solo parcialmente abordado y actualmente está roto, siendo la causa del error P0. Otros endpoints además de la creación de alquileres siguen creando movimientos de caja huérfanos (sin ).

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Errores de sintaxis/indentación en  tras realizar modificaciones.
-   **Recurrence count**: El riesgo persiste y es alto.
-   **Status**: RECURRING.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React (Hooks), TailwindCSS, Shadcn/UI. Lógica de estado muy compleja en  e .
-   **Backend:** FastAPI, Pydantic, motor-asyncio. El concepto clave es el de **Sesiones de Caja** (), que debe gobernar toda la lógica financiera pero actualmente no lo hace correctamente.
-   **Database:** MongoDB.
-   **Architecture:** SPA con una API RESTful monolítica.

**key DB schema**
-   **items:** Incluye nuevos campos:  (bool),  (int),  (int).  y otros campos de trazabilidad son ahora opcionales.
-   **item_types:** Es la única fuente para categorías de artículos. No hay tipos por defecto.
-   **cash_movements:** Debe tener un campo  para vincularlo a una . **Esta vinculación es la que está fallando.**

**changes in tech stack**
-   Ninguno.

**All files of reference**
-   : Modificado para añadir lógica de artículos genéricos, tipos dinámicos y arreglos en los modelos Pydantic.
-   : Modificado masivamente para el formulario y la tabla de artículos genéricos/normales.
-   : Archivo muy modificado para la botonera de añadido rápido, la lógica de precios y múltiples (y fallidos) intentos de arreglar el flujo de pago.
-   : Modificado para eliminar la lógica de precios legacy.

**Areas that need refactoring**:
-   **CRÍTICO:**  es insostenible y una fuente constante de errores. Debe ser descompuesto en una estructura modular (e.g., , , ).
-   **ALTO:**  es extremadamente complejo debido a la acumulación de funcionalidades y correcciones de errores. Debería descomponerse en sub-componentes más pequeños y manejables (ej. , , ).

**key api endpoints**
-    (Actualizado para )
-   
-   
-   
-    y 

**Critical Info for New Agent**
-   **PRIORIDAD MÁXIMA:** Arreglar el bug contable (Issue 1). Los alquileres se completan pero el dinero no se registra en la caja. El sistema es inutilizable en su estado actual. Investiga  en  y los endpoints relacionados con la creación de movimientos de caja.
-   **NO REIMPLEMENTAR EL FLUJO AUTOMÁTICO DE CAJA:** Los intentos de abrir la caja automáticamente desde la pantalla de cobro han fallado repetidamente, causando errores críticos del servidor (). Mantén el flujo actual y desacoplado: el usuario debe abrir la caja manualmente en el módulo de  antes de poder cobrar un alquiler. Comunica esto claramente al usuario si pregunta.
-   **PRECAUCIÓN EXTREMA con :** Este archivo es un campo de minas. Ha sido modificado tantas veces para arreglar el flujo de pago que es muy frágil. Cualquier cambio aquí necesita ser mínimo y probado exhaustivamente.
-   **La raíz del problema es la sincronización:** El bug actual es un síntoma de una tarea más grande e incompleta: asegurar que TODAS las operaciones financieras se vinculen a una sesión de caja. Arreglar el cobro de alquileres es solo el primer paso.

**documents and test reports created in this job**
-   
-   
-   
-    (actualizado)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Reporta que el sistema crashea al abrir caja y cobrar simultáneamente. Pide un flujo de 2 pasos.
2.  **Agent:** Implementa el flujo de 2 pasos.
3.  **User:** El sistema sigue bloqueado. Pide un bypass total, desacoplando completamente la apertura de caja del cobro.
4.  **Agent:** Implementa el bypass. Ahora el usuario debe abrir la caja manualmente.
5.  **User:** Reporta que el sistema sigue fallando, creyendo que es por un driver de cajón que no existe.
6.  **Agent:** Investiga, no encuentra referencias a hardware, pero corrige un endpoint de API () y verifica que la apertura manual funciona.
7.  **PENDING HUMAN MESSAGE (CRITICAL):**
    -   **User:** ERROR CRÍTICO EN CONTABILIDAD: El arqueo de caja sale a cero porque los cobros de Nuevo Alquiler no se están sumando al saldo de la caja activa. Ejecuta esta reestructuración de datos...
    -   **Status:** **UNADDRESSED**. This is the highest priority task for the next agent.

**Project Health Check:**
-   **Broken**: Sí. El núcleo de la funcionalidad contable (registrar ingresos de alquileres) no funciona.
-   **Mocked**: , .

**3rd Party Integrations**
-   
-   , 

**Testing status**
-   **Testing agent used after significant changes**: YES. Se usó para validar funcionalidades de frontend como la edición de precios y los botones de acceso rápido.
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: []
-   **Known regressions**: La funcionalidad de registrar los pagos de alquiler en la caja, que pudo haber funcionado en un punto, está ahora completamente rota.

**Credentials to test flow:**
-   Registra un nuevo usuario desde la interfaz de login.

**What agent forgot to execute**
-   El agente no completó ni validó la tarea de **Sincronización omnicanal de caja**. Se centró en los síntomas del flujo de  sin asegurar que la lógica contable subyacente (crear un  y vincularlo a la ) funcionara correctamente. Este descuido es la causa directa del error crítico actual.</analysis>
