<analysis>**original_problem_statement:**
El usuario ha solicitado una transformación arquitectónica completa de la aplicación para convertirla en una plataforma multi-tenant (SaaS), junto con optimizaciones de rendimiento y correcciones de errores. Las solicitudes clave incluyen:

1.  **Transformación a Multi-Tenant (CRÍTICO):**
    *   Añadir un campo  a todas las colecciones de datos relevantes (Clientes, Artículos, Alquileres, etc.).
    *   Implementar un aislamiento de datos estricto para que cada tienda solo pueda ver y modificar sus propios datos.
    *   Crear un rol  con acceso a todas las tiendas y un panel de gestión.
    *   Migrar los datos existentes a una tienda principal ().
    *   Crear un frontend para que el  gestione tiendas (crear, editar, ver).

2.  **Fallo Crítico de Aislamiento (Último Reporte):** El usuario ha detectado que al crear una tienda nueva, esta hereda datos (clientes, stock, alquileres) de la tienda principal, rompiendo el modelo SaaS. **Esto es el problema más urgente a resolver.**

3.  **Optimización de Rendimiento:**
    *   Corregir el cuelgue de las páginas de  e  al manejar grandes volúmenes de datos.
    *   Implementar paginación del lado del servidor (server-side pagination) y scroll infinito.
    *   Implementar búsqueda del lado del servidor (server-side search) con debounce.

4.  **Correcciones y Mejoras de UI:**
    *   Eliminar un filtro de fecha no funcional en la página de .
    *   Reparar el botón Configurar en el nuevo panel de gestión de tiendas.
    *   Añadir una función de impersonation para que el Super Admin pueda acceder como una tienda específica.
    *   Resolver un bug donde los artículos recién importados no aparecían en el buscador de Nuevo Alquiler.
    *   Arreglar la persistencia del logo de la empresa en la página de .

**User's preferred language**: Spanish

**what currently exists?**
La aplicación ha sido re-arquitecturada en el backend para soportar un modelo multi-tenant. La base de datos ha sido migrada para incluir  en todas las colecciones principales. Se han creado los roles  (para tiendas) y  (global). La autenticación ha sido modificada para incluir el  en el token JWT.

Se han implementado optimizaciones de rendimiento críticas en las páginas de  e , reemplazando la carga masiva de datos con scroll infinito y búsqueda del lado del servidor.

En el frontend, se ha creado una nueva página  para que el Super Admin pueda ver y crear tiendas, y una página  para editarlas. Sin embargo, la implementación de aislamiento de datos es defectuosa, ya que las nuevas tiendas no están vacías como deberían.

**Last working item**:
-   Last item agent was working: El agente estaba diagnosticando un **fallo crítico de aislamiento de datos**. El usuario reportó que al crear una nueva tienda, esta aparecía con datos (stock, clientes, alquileres) heredados de la tienda principal, lo cual es inaceptable para un modelo SaaS.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? both. Es crucial realizar una prueba de aislamiento completa:
    1.  Como , crear una Tienda de Prueba 3.
    2.  Crear un usuario  para esa tienda.
    3.  Desloguearse y loguearse como el nuevo usuario de la Tienda 3.
    4.  Navegar a **TODAS** las páginas (Dashboard, Clientes, Inventario, Alquileres Activos, Devoluciones, Caja).
    5.  Verificar que **TODOS** los contadores (clientes, artículos, alquileres pendientes) estén en CERO y todas las tablas estén vacías.
    6.  Verificar que la página de  no herede configuraciones como precios (Tarifas, Packs).
-   User Testing Done: Y (El usuario encontró el fallo).

**All Pending/In progress Issue list**:
-   Issue 1: (P0 - CRITICAL BLOCKER) Fallo de aislamiento de datos: Las nuevas tiendas heredan datos de la tienda principal.
-   Issue 2: (P2 - Low Priority) Los checkboxes para la selección masiva en la página de Clientes () no son visibles.
-   Issue 3: (P2 - Low Priority) La persistencia del logo de la empresa en  no ha sido probada.

**Issues Detail:**
-   **Issue 1**: Fallo de aislamiento de datos: Las nuevas tiendas heredan datos de la tienda principal.
    -   **Attempted fixes**: El agente aplicó de forma masiva el filtro  a más de 150 consultas en el backend (). Sin embargo, es evidente que algunas consultas, especialmente las que cargan datos iniciales o para contextos globales, se han omitido.
    -   **Next debug checklist**:
        1.  **Auditoría Completa de **: Revisar CADA endpoint y CADA llamada a la base de datos (, , , , , etc.) para asegurar que el filtro  está presente. Prestar especial atención a las queries complejas con  o .
        2.  **Auditoría de Frontend Data Fetching**: Revisar , todos los contextos de React (, ) y los componentes principales (, ) para identificar llamadas a la API que puedan estar pidiendo datos sin filtrar por tienda.
        3.  **Colecciones de Configuración**: Investigar las colecciones  y . Estas parecen ser globales. Deben modificarse para incluir un  y ser filtradas en consecuencia.
        4.  **Reproducir y Aislar**: Seguir los pasos de prueba descritos en Last working item para identificar qué página o componente específico está mostrando los datos heredados primero.
    -   **Why fix this issue and what will be achieved with the fix?**: Es el pilar fundamental de la arquitectura SaaS. Sin esto, la aplicación es inutilizable por múltiples clientes.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Both
    -   **Blocked on other issue**: No, este es el principal bloqueador.

-   **Issue 2**: Los checkboxes para la selección masiva en la página de Clientes no son visibles.
    -   **Attempted fixes**: Ninguno. Este es un bug antiguo y de baja prioridad.
    -   **Next debug checklist**: Inspeccionar el DOM y el CSS de la tabla en  para encontrar la regla de estilo que está ocultando los checkboxes.
    -   **Why fix this issue and what will be achieved with the fix?**: Mejora la usabilidad de la gestión de clientes.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: Issue 1.

**In progress Task List**:
(Ninguno, todo el trabajo actual se centra en resolver el Issue 1).

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    *   (P0) **Refactorización del Backend**: Dividir el archivo monolítico  en una estructura modular (routers, services, models). La dificultad para implementar el multi-tenant demuestra que esto es ahora una necesidad crítica.
    *   (P1) **Refactorización de Componentes Frontend**: Descomponer los componentes masivos como  (3400+ líneas),  (3300+ líneas) y  (1900+ líneas) en componentes más pequeños y manejables.
-   **Future Tasks:**
    *   Crear una Pestaña de Soporte y Mejoras.
    *   Implementar personalización de la tabla de Inventario con Drag & Drop.
    *   Integraciones de terceros (VeriFactu, WhatsApp API).
    *   Implementar un Buscador Global en la aplicación.

**Completed work in this session**
-   **Transformación a Multi-Tenant (Backend - Parcialmente Exitoso)**: Migrada la BD, creados roles, y refactorizada la autenticación. La mayoría de los endpoints fueron actualizados para filtrar por .
-   **Panel de Super Admin (Frontend)**: Creadas las páginas  y  para la gestión de tiendas. El menú de navegación se actualiza según el rol.
-   **Función de Impersonation**: Creado el endpoint  y la lógica de UI para que el Super Admin pueda acceder como una tienda.
-   **Optimización de Rendimiento (Clientes e Inventario)**: Implementado con éxito el scroll infinito y la búsqueda/paginación del lado del servidor, solucionando los cuelgues de la aplicación.
-   **Corrección de Bug (Clientes)**: Solucionado un bucle de renderizado infinito que bloqueaba la página de Clientes.
-   **Mejora de UI (Caja)**: Eliminado un filtro de fecha no funcional de la página , limpiando la interfaz.
-   **Corrección de Bug (Buscador)**: Solucionado un problema por el cual los artículos recién importados no aparecían en el buscador de Nuevo Alquiler.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: Los checkboxes de selección masiva en  son invisibles.
-   **Issue 2**: La persistencia del logo en  no se ha probado y podría no funcionar.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: La complejidad de los archivos monolíticos (, , etc.) es la causa raíz de la mayoría de los problemas. El intento fallido del agente de usar scripts para parchear  y el actual fallo de aislamiento de datos son consecuencias directas de esta deuda técnica.
-   **Recurrence count**: Muy alto.
-   **Status**: El patrón persiste y se agrava. La refactorización es ahora crítica para la estabilidad.

**Code Architecture**


**Key Technical Concepts**
-   **Multi-Tenancy (SaaS)**: Transformación de la arquitectura para aislar los datos por tienda ().
-   **Data Isolation**: Uso de un middleware y dependencia en FastAPI para inyectar filtros  en todas las consultas a la base de datos.
-   **JWT Payload Customization**: Modificación del token para incluir  y , permitiendo la lógica de autorización en el backend y frontend.
-   **Server-Side Pagination & Infinite Scroll**: Carga de datos en lotes desde el servidor a medida que el usuario hace scroll, usando  en el frontend.
-   **Debounced Server-Side Search**: Optimización de la búsqueda para que consulte a la base de datos en lugar de filtrar en el cliente, con un  para evitar peticiones excesivas.
-   **Automated Code Modification (y sus riesgos)**: El agente intentó usar scripts para refactorizar , lo que resultó en errores de sintaxis masivos, destacando los peligros de este enfoque en código complejo.

**key DB schema**
-   **stores**: (Nueva colección) 
-   **users**: (Modificado) 
-   **customers, items, rentals, cash_closings, cash_movements**: (Modificado) Se ha añadido el campo  a todos los documentos. Se han creado índices compuestos sobre .
-   **tariffs, packs**: (PENDIENTE DE MODIFICACIÓN) Actualmente son globales. Necesitan un campo  para un aislamiento completo.

**All files of reference**
-   **/app/backend/server.py**: Archivo principal del backend, masivamente modificado para la lógica multi-tenant.
-   **/app/backend/multitenant.py**: Nuevo helper para la lógica de aislamiento y autenticación.
-   **/app/frontend/src/pages/Customers.jsx**: Modificado para implementar rendimiento con scroll infinito.
-   **/app/frontend/src/pages/Inventory.jsx**: Modificado para implementar rendimiento con scroll infinito.
-   **/app/frontend/src/pages/StoreManagement.jsx**: Nueva página para el panel de Super Admin.
-   **/app/frontend/src/pages/StoreSettings.jsx**: Nueva página para la configuración de una tienda específica.
-   **/app/frontend/src/App.js**: Modificado para gestionar las nuevas rutas y la lógica de roles.
-   **/app/frontend/src/components/Layout.jsx**: Modificado para mostrar condicionalmente el enlace de gestión de tiendas.

**Areas that need refactoring**:
-   **CRÍTICO:**  es un monolito inmanejable. La dificultad para aplicar el filtro  de forma fiable demuestra que su división en módulos (routers, servicios) es la máxima prioridad de refactorización para garantizar la estabilidad.
-   **CRÍTICO:** Las colecciones  y  parecen ser globales. Esto rompe el aislamiento y debe corregirse añadiendo  y actualizando toda la lógica que las consume, especialmente en .
-   **ALTO:** Los componentes de frontend como , , y  son enormes y complejos, lo que probablemente contribuye al bug de aislamiento de datos.

**key api endpoints**
-   : (Nuevo) Permite a un Super Admin obtener un token para una tienda específica.
-   : (Nuevo) Lista todas las tiendas (solo Super Admin).
-   : (Nuevo) Crea una nueva tienda (solo Super Admin).
-   : (Nuevo) Actualiza los datos de una tienda (solo Super Admin).
-   Todos los demás endpoints (, , etc.) han sido modificados internamente para filtrar por el  del usuario autenticado.

**Critical Info for New Agent**
-   **Tu prioridad #1, absoluta e innegociable, es arreglar el fallo de aislamiento de datos.** No avances en ninguna otra tarea hasta que las tiendas nuevas se creen 100% vacías.
-   **No confíes en que los filtros  existentes son suficientes.** El agente anterior hizo un trabajo masivo pero incompleto. Debes auditar CADA consulta a la BD. Empieza por las colecciones que probablemente son globales y no deberían serlo, como  y .
-   **Ten cuidado con la refactorización automatizada.** El agente anterior perdió mucho tiempo y casi corrompe el código al intentar usar scripts para parchear . Dada la complejidad, un enfoque manual y sistemático, aunque más lento, es más seguro.
-   **El usuario es técnico y espera ver resultados tangibles.** Comunica tus planes claramente y céntrate en implementar las interfaces de usuario que demuestren que los cambios de backend funcionan.

**documents and test reports created in this job**
-   
-   
-   
-    (backup de la base de datos)

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request (P0 - BLOCKER)**: FALLO CRÍTICO DE AISLAMIENTO: LAS TIENDAS NUEVAS NO ESTÁN VACÍAS. El usuario reporta que las nuevas tiendas heredan datos. - **Status: IN PROGRESS**
2.  **Request**: EL BOTÓN CONFIGURAR EN GESTIÓN DE TIENDAS NO FUNCIONA. Pide reparar el botón y añadir página de ajustes y función de impersonation. - **Status: RESOLVED**
3.  **Feedback**: Como usuario no veo ninguna diferencia visual. Pide ver el panel de Super Admin y el identificador de tienda en la UI. - **Status: RESOLVED**
4.  **Confirmation**: El usuario confirma proceder con la transformación a multi-tenant. - **Status: N/A**
5.  **Information**: El usuario proporciona el nombre de la tienda: EL ENEBRO. - **Status: N/A**
6.  **Request**: TRANSFORMACIÓN A ARQUITECTURA MULTI-TENANT. Petición de la refactorización completa a SaaS. - **Status: IN PROGRESS (con bugs)**
7.  **Bug Report**: LOS ARTÍCULOS IMPORTADOS NO APARECEN EN EL BUSCADOR. - **Status: RESOLVED**
8.  **Request**: ELIMINACIÓN DE ELEMENTO INÚTIL: FILTRO DE CAJA. - **Status: RESOLVED**
9.  **Request**: REPARACIÓN DE INVENTARIO: ELIMINAR BLOQUEO DE CARGA. Pide optimizar la página de Inventario. - **Status: RESOLVED**
10. **Request**: OPTIMIZACIÓN ESTRUCTURAL: ESCALABILIDAD PARA... CLIENTES. Pide optimizar la página de Clientes. - **Status: RESOLVED**

**Project Health Check:**
-   **Broken**: Sí. El fallo crítico en el aislamiento de datos hace que la funcionalidad principal de SaaS no funcione.

**3rd Party Integrations**
-    (SheetJS)

**Testing status**
-   **Testing agent used after significant changes**: NO. El agente ha realizado pruebas manuales extensas con  y , pero no ha ejecutado un flujo de prueba completo con el testing agent desde la implementación de multi-tenant.
-   **Troubleshoot agent used after agent stuck in loop**: NO. El agente se atascó con los scripts de refactorización pero se recuperó usando .
-   **Test files created**: N/A
-   **Known regressions**: El aislamiento de datos, que es una nueva característica, está implementado de forma incorrecta.

**Credentials to test flow:**
-   **Super Admin**:  / 
-   **Tienda 1 (EL ENEBRO)**:  / 
-   **Tienda 2 (Prueba)**:  / 

**What agent forgot to execute**
-   El agente no completó correctamente la implementación del aislamiento de datos, dejando fugas de datos entre tiendas.
-   El agente nunca llegó a probar la funcionalidad de persistencia del logo solicitada en el handoff original.
-   El bug de los checkboxes invisibles en la página de Clientes sigue sin resolverse.</analysis>
