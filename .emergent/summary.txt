<analysis>**original_problem_statement:**
El problema original del usuario era un error contable, que ha evolucionado hacia una refactorización y la adición de múltiples funcionalidades para un sistema de gestión de alquiler de esquí. Las solicitudes se han centrado en optimizar flujos de trabajo con lectores de códigos de barras, mejorar la usabilidad, corregir bugs, y recientemente, en transformar la aplicación para que sea funcional sin conexión (PWA) e implementar nuevas características de gestión.

**PRODUCT REQUIREMENTS (Consolidated & Updated):**
1.  **Gestión Central:** Alquileres, Devoluciones (incluyendo parciales para artículos genéricos), Inventario, Clientes (con borrado masivo), Proveedores.
2.  **Módulos Financieros:** Dashboard Operativo (con métricas auditadas), Gestión de Caja (con UI de privacidad mejorada), Reportes Unificados (con fuente única de datos), Panel de Rentabilidad.
3.  **Flujos de Trabajo Optimizados (Scanner-First):** Entrada automática en inventario, captura global de escáner (HID), navegación por teclado profesional.
4.  **Arquitectura Offline-First (PWA):** La aplicación debe ser funcional sin conexión a internet, utilizando una base de datos local (IndexedDB con Dexie.js) y una cola de sincronización para actualizar los datos cuando se recupera la conexión.
5.  **Persistencia de Estado:** El carrito de 'Nuevo Alquiler' debe persistir en  para no perderse al navegar entre pestañas.
6.  **Sistema de Impresión Unificado:** Servicio de impresión global no bloqueante.
7.  **Mejoras de UI/UX:**
    *   Edición en línea en el carrito.
    *   Selección y borrado masivo en la tabla de Clientes.
8.  **Bugs Críticos:**
    *   Corregir el cálculo de precios para packs/combos.
    *   Eliminar discrepancias de datos entre Caja y Reportes.
    *   Solucionar el bug visual que impide que los checkboxes de selección masiva aparezcan para el usuario.

**User's preferred language**: Spanish

**what currently exists?**
Un sistema full-stack (React, FastAPI, MongoDB) para gestión de alquiler de esquí. La aplicación ha sido significativamente mejorada con una arquitectura PWA Offline-First, usando Dexie.js para la base de datos local y un Service Worker para el caché de la aplicación. Se implementó una lógica financiera unificada (Single Source of Truth) para eliminar discrepancias entre la Caja y los Reportes. Además, se corrigieron bugs críticos en el cálculo de precios de packs, se rediseñó la UI de privacidad en la caja, se añadió persistencia al carrito de alquiler y se implementó la funcionalidad de borrado masivo de clientes. Un error de sincronización inicial de la PWA fue resuelto.

**Last working item**:
-   Last item agent was working: El usuario ha solicitado una nueva funcionalidad para permitir **devoluciones parciales de artículos genéricos** (ej: devolver 1 de 3 cascos alquilados). El agente comenzó la fase de análisis, revisando el código de  y los endpoints del backend en  para entender la lógica actual antes de implementar los cambios.
-   Status: NOT STARTED
-   Agent Testing Done: N
-   Which testing method agent to use? both
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   Issue 1: (P0) Los checkboxes para la selección masiva en la página de Clientes no son visibles para el usuario.

**Issues Detail:**
-   **Issue 1**: Los checkboxes para la selección masiva en la página de Clientes no son visibles para el usuario.
    -   **Attempted fixes**: El agente verificó que el código en  era correcto y forzó una reconstrucción completa del frontend. Aunque el agente pudo ver los checkboxes en su entorno, la captura de pantalla del usuario confirmó que el problema persistía. La última sugerencia del agente fue que el usuario limpiara la caché del navegador manualmente.
    -   **Next debug checklist**:
        1.  Revisar la estrategia de caché del Service Worker en . Es probable que esté sirviendo una versión antigua de los archivos de la página de Clientes. Considerar cambiar la estrategia a  para esta página o implementar una lógica de invalidación de caché más robusta.
        2.  Investigar posibles conflictos de CSS que puedan estar ocultando los checkboxes (, , z-index).
        3.  Instruir al agente para que guíe al usuario sobre cómo abrir las herramientas de desarrollador y verificar si hay errores de consola en su navegador.
    -   **Why fix this issue and what will be achieved with the fix?**: La funcionalidad de borrado masivo, que ya está implementada en el backend, es completamente inutilizable sin los checkboxes para seleccionar los clientes.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: No

**In progress Task List**:
-   N/A

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    *   (P0) **Implementar devoluciones parciales** para artículos genéricos en la página de Devoluciones.
    *   (P1) **Refactorización del Backend**: Dividir el monolito  en una estructura de carpetas (routers, models, services).
    *   (P2) **Conectar Lógica de Configuración 'Hardware'**: Vincular los interruptores de la UI a la lógica de auto-impresión.
    *   (P3) **Crear Pestaña de Soporte y Mejoras.**
    - (P4) **Implementar personalización de la tabla de Inventario (Drag & Drop)**.
-   **Future Tasks:**
    *   Integraciones (VeriFactu, WhatsApp API, TPV, Email, Google Calendar).
    *   Sistema de Reservas Online.
    *   Buscador Global.
    *   Importador Universal (CSV/Excel).

**Completed work in this session**
-   **Feature: Auditoría y Corrección del Dashboard (DONE):** Se revisó y corrigió la lógica de cálculo para el porcentaje de stock, clientes atendidos hoy y la precisión general de los datos en  y .
-   **Feature: Persistencia del Carrito de Alquiler (DONE):** Se implementó  para guardar el estado del carrito en  usando un nuevo hook .
-   **Feature: Rediseño de Privacidad en Caja (DONE):** Se eliminó el efecto  en  y se reemplazó con un sistema de acordeón para mostrar/ocultar datos sensibles.
-   **Bug Fix: Corrección de Precios de Packs (DONE):** Se arregló la lógica en  para que el precio de los packs se calcule usando tarifas escalonadas por día.
-   **Feature: Unificación Financiera (Single Source of Truth) (DONE):** Se creó un  centralizado en  para eliminar discrepancias de datos entre la Caja y los Reportes.
-   **Feature: Implementación Base de PWA Offline-First (DONE):** Se configuró la arquitectura PWA con , un , y un  para permitir la funcionalidad offline.
-   **Bug Fix: Corrección de Error de Sincronización PWA (DONE):** Se solucionó un error 500 que impedía la sincronización inicial, ajustando el modelo Pydantic  para que campos opcionales no bloquearan la carga.
-   **Feature: Selección y Borrado Masivo en Clientes (PARTIALLY DONE / BLOCKED):** Se implementó la UI y lógica en  y los endpoints en . La funcionalidad está bloqueada porque el usuario no puede ver los checkboxes de selección.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: **Monolito en el backend ().**
    -   **Debug checklist**: Planificar la división del archivo en carpetas: , , .
    -   **Why to solve this issue and what will be achieved with this?**: Reducir la deuda técnica y mejorar la mantenibilidad del código.
    -   **Should Test frontend/backend/both after fix**: backend
    -   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Errores de sintaxis/indentación en .
-   **Recurrence count**: Alto. El riesgo persiste debido al tamaño del archivo ( líneas). El refactor es la solución definitiva.
-   **Status**: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **PWA (Progressive Web App):** Uso de Service Workers para caché de assets y  para la instalación.
-   **Offline Data Persistence:** Uso de  como wrapper de IndexedDB para replicar la base de datos en el cliente.
-   **Background Synchronization:** Sistema de cola () que procesa operaciones pendientes cuando se recupera la conexión, usando .
-   **Centralized Service Layer (Backend):** Creación de un  en  como Single Source of Truth para los cálculos financieros.
-   **State Management con Persistencia:** Creación de un hook personalizado () que abstrae la lógica de .
-   **Global Event Listeners**: Hook  para la funcionalidad de escáner HID.
-   **MongoDB Aggregation**: Uso de pipelines de agregación para estadísticas complejas.

**key DB schema**
-   No hubo cambios estructurales en las colecciones de MongoDB, pero el modelo Pydantic  fue modificado para hacer los campos  y  opcionales, solucionando un error de serialización con datos antiguos.

**changes in tech stack**
-   : Para la gestión de IndexedDB.
-   : Para integrar Dexie con componentes de React.
-   : Para facilitar la gestión del Service Worker.

**All files of reference**
-   **Nuevos:**
    -   
    -   
    -   
    -   
    -   
    -   
    -   
-   **Modificados Críticos:**
    -   : Múltiples adiciones y refactorizaciones (Servicio Financiero, endpoints de borrado masivo, corrección de modelo ).
    -   : Implementación de la selección y borrado masivo.
    -   : Integración de persistencia y corrección de precios de packs.
    -   : Rediseño de la UI de privacidad.
    -   : Lógica de obtención de datos actualizada para usar endpoints unificados.
    -   : Integración de proveedores de contexto y registro del Service Worker.
    -   : Adición del indicador de estado offline.

**Areas that need refactoring**:
-   **CRÍTICO:**  es un monolito inmanejable y la principal fuente de deuda técnica. Su refactorización es urgente.
-   **ALTO:**  y  han acumulado una gran cantidad de lógica y se beneficiarían de ser descompuestos en componentes más pequeños.

**key api endpoints**
-   : **(NUEVO)** Elimina un listado de clientes por sus IDs.
-   : **(NUEVO)** Recibe una lista de IDs de clientes y devuelve cuáles tienen alquileres activos.
-   : **(NUEVO)** Endpoint de depuración para comparar las transacciones de  vs. .
-   , : **(MODIFICADO)** Ahora utilizan el  centralizado.
-   : **(MODIFICADO)** Lógica de cálculo completamente revisada para mayor precisión.
-   : **(MODIFICADO)** Se corrigió el modelo de respuesta Pydantic para manejar datos heredados sin fallar.

**Critical Info for New Agent**
-   **Prioridad Inmediata:** La tarea principal es implementar la nueva funcionalidad solicitada: **Devolución Parcial de Artículos Multi-Cantidad**.
-   **Bloqueador a Resolver Primero:** Antes de iniciar la nueva tarea, debes solucionar el bug visual que impide al usuario ver los **checkboxes en la página de Clientes**. Este problema probablemente está relacionado con la estrategia de caché del Service Worker (). Investiga y resuelve esto para desbloquear la funcionalidad de borrado masivo.
-   **Contexto PWA:** La aplicación acaba de ser convertida a PWA. Ten en cuenta que esto introduce capas de caché (Service Worker) y una base de datos local (Dexie) que pueden causar comportamientos inesperados como el bug de los checkboxes.
-   **Monolito del Backend:** Procede con extrema precaución al editar . Es un archivo muy grande y propenso a errores.

**documents and test reports created in this job**
-   
-   
-   
-    (actualizado continuamente)

**Last 10 User Messages and any pending HUMAN messages**
10. **User**: No me aparecen los cambios ultimos (The latest changes are not showing up). - *PENDING*
9.  **User**: *Uploads image showing Customers page without checkboxes*. - *PENDING*
8.  **User**: Que no aparecen los checks. (The checks don't appear). - *PENDING*
7.  **User**: Requests feature for bulk selection and deletion in Customers. - *DONE (but blocked by UI bug)*
6.  **User**: Me salta error de sincronización (I'm getting a sync error). - *RESOLVED*
5.  **User**: Requests feature to transform app to Offline-First (PWA). - *DONE*
4.  **User**: Requests fix for discrepancy between Cash Management and Sales Reports. - *DONE*
3.  **User**: Requests fix for technical error in pack price calculation. - *DONE*
2.  **User**: Requests redesign of privacy feature in Cash Management. - *DONE*
1.  **User**: Requests partial return functionality for multi-quantity generic items. - *NOT STARTED (Current Task)*

**Project Health Check:**
-   **Broken**: Parcialmente. La funcionalidad de borrado masivo de clientes es inutilizable para el usuario debido al bug visual de los checkboxes faltantes.
-   **Mocked**: No.

**3rd Party Integrations**
-   
-   , 
-   
-   
-   
-   

**Testing status**
-   **Testing agent used after significant changes**: YES
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Ninguno.
-   **Known regressions**: La UI para la selección masiva de clientes no se renderiza correctamente para el usuario final, bloqueando la funcionalidad.

**Credentials to test flow:**
-   Usuario:  / 

**What agent forgot to execute**
-   El agente no diagnosticó a fondo la causa raíz del porqué los checkboxes no aparecían para el usuario. La solución propuesta (limpiar caché manualmente) no es robusta. La causa probable (caché del Service Worker) no fue investigada ni resuelta de manera definitiva.</analysis>
