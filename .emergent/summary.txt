<analysis>**original_problem_statement:**
Crear un sistema de gestión completo para tiendas de alquiler de equipos de esquí/snowboard.

**PRODUCT REQUIREMENTS (Consolidated & Updated):**
1.  **Gestión Central:** Alquileres, Devoluciones, Inventario (con código interno manual), Clientes (con historial financiero), Proveedores, Tarifas.
2.  **Módulos Financieros:**
    *   **Dashboard Estratégico:** Con calendario de ocupación, rankings de rendimiento, y un nuevo panel de Control de Devoluciones.
    *   **Gestión de Caja:** Con arqueo manual detallado, historial, y posibilidad de revertir cierres. Debe registrar y sincronizar todos los movimientos y permitir múltiples turnos/sesiones por día.
    *   **Reportes Flexibles:** Con filtro por rango, botones de selección rápida y comparativa interanual.
    *   **Rentabilidad de Inventario:** Trackear coste, ingresos, amortización y beneficio neto por artículo.
3.  **Flujos de Trabajo Optimizados:**
    *   **Numeración Unificada:** Todos los movimientos de caja (ventas, devoluciones, salidas) deben seguir una secuencia única AXXXXXX.
    *   **Gestión de Cambios Centralizada (SWAP):** Un modal global en la lista de alquileres activos para gestionar cambios de material, gama o duración, con cálculo automático de la diferencia económica.
    *   **Precios por Tramos (Look-up):** El sistema debe usar tarifas escalonadas en lugar de multiplicación lineal (Precio Base * Días).
    *   **Borrado Masivo en Inventario:** Habilitar selección múltiple y borrado (lógico o físico) de artículos.
    *   **Visualización de Packs FUSIONADA:** UNA SOLA LÍNEA por pack en el carrito y ticket, con los códigos internos de los componentes incrustados en el nombre del pack. (Ej: ).
    *   **Visibilidad en Mantenimiento:** La vista de Mi Flota debe mostrar información detallada (modelo, talla, usos) y estar sincronizada con las alertas del Dashboard.
    *   **Ticket Completo y Claro:** El ticket impreso debe ser un comprobante profesional, con desglose claro, indicación de IVA Incluido y sin la columna P.Unit.
    *   **Buscador Global de Gestión Rápida (Reverse Lookup):** Una barra de búsqueda universal que, al escanear un artículo, abre directamente el modal de gestión del cliente que lo tiene alquilado.
4.  **Sistema de Tickets/Comprobantes:** Impresión como comprobante de un pago ya realizado.
5.  **Gestión de Datos:**
    *   **Importador Universal (CSV/Excel):** Para clientes e inventario.
6.  **Soporte y Personalizaciones:** Pestaña para que el usuario pueda abrir tickets de soporte.
7.  **Integraciones Futuras:** VeriFactu, WhatsApp, TPV, Email, Google Calendar.

**User's preferred language**: Spanish

**what currently exists?**
Es un sistema full-stack (React, FastAPI, MongoDB) para la gestión de alquileres de esquí. En esta sesión, se han implementado funcionalidades de alto impacto en la usabilidad del operario. Se creó un sistema de Modo Canje (Swap) centralizado y un Buscador Global Inteligente en la página de Alquileres Activos, permitiendo identificar a un cliente y gestionar su contrato escaneando cualquiera de sus artículos. También se rediseñó la vista de Alquileres Activos a un formato compacto de una línea por cliente. Finalmente, se comenzó a integrar esta lógica de gestión de cambios en la pantalla de Devoluciones, aunque esta última implementación está a medio camino y requiere una corrección integral.

**Last working item**:
-   Last item agent was working: El agente estaba corrigiendo y rediseñando la funcionalidad del botón GESTIONAR CAMBIO en la pantalla de Devoluciones (). La instrucción es que, al pulsar este botón en la línea de cualquier artículo, se abra un modal de gestión que controle el **contrato completo** del cliente, no solo ese artículo. Este modal debe permitir cambios de material (upgrade/downgrade), prórrogas de días (ampliación/reducción), calcular el neto financiero de todas las operaciones combinadas, y obligar a pasar por caja si el saldo no es cero.
-   Status: IN PROGRESS
-   Agent Testing Done: N
-   Which testing method agent to use? frontend testing agent
-   User Testing Done: N

**All Pending/In progress Issue list**:
-   **Issue 1**: (P0) **Corregir y finalizar el modal de GESTIONAR CAMBIO en la página de Devoluciones.**
    -   **Description**: El agente comenzó a implementar la lógica, pero el usuario especificó que debe ser más completa. El modal actual es incorrecto y necesita ser reemplazado para manejar múltiples casuísticas sobre el contrato entero.
    -   **Next debug checklist**:
        1.  Revisar y finalizar la reescritura de los estados () en  para gestionar el estado del contrato completo (lista de artículos, cambios pendientes, nueva fecha de fin, etc.).
        2.  Eliminar completamente el código JSX del modal de cambio existente en .
        3.  Implementar un nuevo JSX para el modal que:
            *   Muestre una lista de **todos** los artículos del contrato del cliente.
            *   Junto a cada artículo, tenga un botón de Sustituir que active un input para escanear el nuevo código.
            *   Incluya un selector de fecha único () para prorrogar o reducir la duración de **todo** el contrato.
            *   Muestre en tiempo real el cálculo del balance económico () total, sumando diferencias por cambio de material y por cambio de días.
        4.  Implementar la lógica en  para recalcular este balance cada vez que se añade un cambio o se modifica la fecha.
        5.  El botón de confirmación final debe ser dinámico: Confirmar y Pasar por Caja si hay un delta, o Confirmar Cambios si es cero.
        6.  Conectar la confirmación a un endpoint de backend que procese los cambios de inventario y genere el movimiento de caja correspondiente.
    -   **Why fix this issue and what will be achieved with the fix?**: Unificará la experiencia de gestión y permitirá al operario resolver cualquier cambio o prórroga desde una única pantalla, agilizando drásticamente las operaciones en el mostrador.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y (La lógica del modal de cambio ha sido iterada varias veces).
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None.

**In progress Task List**:
-   **Task 1**: (P2) Implementar personalización de la tabla de Inventario (Drag & Drop).
    -   **Where to resume**: La dependencia  está instalada. El trabajo en  fue pausado.
    -   **What will be achieved with this?**: Ofrecerá una experiencia de usuario altamente personalizada.
    -   **Status**: IN PROGRESS (Paused)
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on something**: Tareas de flujo de trabajo crítico tienen mayor prioridad.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) **Refactorización del Backend**: Dividir el monolito  en una estructura modular (routers, models, services) para mejorar la estabilidad y mantenibilidad.
    -   (P2) **Crear Pestaña de Soporte y Mejoras:** Crear una nueva página con un formulario para que el usuario pueda solicitar nuevas funcionalidades o reportar problemas.
    -   (P2) **Finalizar Sistema de Impresión Automática:** Implementar el interruptor Impresión Automática en  y conectar su estado a los flujos de trabajo.
-   **Future Tasks:**
    -   Integraciones (VeriFactu, WhatsApp API, TPV, Email, Google Calendar).
    -   Sistema de Reservas Online.
    -   Modo Oscuro.

**Completed work in this session**
-   **Sistema de Cambios Centralizado ()**: Implementado en . Un modal inteligente con lógica de escáner permite sustituir artículos y calcula la diferencia de precio en tiempo real.
-   **UI Compacta en Alquileres Activos**: La página  fue rediseñada para mostrar una sola fila por cliente, con un  para ver el detalle de los artículos.
-   **Buscador Inteligente en Cabecera de Alquileres Activos**: Se añadió una cabecera fija en  con un buscador híbrido (código de artículo/nombre de cliente) y un botón CAMBIOS para un acceso rápido al gestor universal.
-   **Inicio de Cambio/Prórroga en Devoluciones**: Se añadió el botón CAMBIO en  y se modificó el backend () para devolver más datos. La implementación inicial del modal fue incorrecta y está siendo reemplazada.
-   **Reversión de Funcionalidad**: Se implementó un buscador global en el , pero fue revertido por petición del usuario para ser re-implementado de forma más integrada dentro de .

**Earlier issues found/mentioned but not fixed**
-   **Issue 1**: **Inconsistencia en el diseño del ticket.** El usuario ha solicitado múltiples cambios en el diseño del ticket. Es un tema propenso a cambios recurrentes.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Errores de sintaxis/indentación en  tras realizar modificaciones.
-   **Recurrence count**: El riesgo persiste y es alto debido a la naturaleza monolítica del archivo. Se recomienda encarecidamente priorizar la refactorización.
-   **Status**: RECURRING.

**Code Architecture**


**Key Technical Concepts**
-   **Gestor Universal de Cambios**: Se ha consolidado una lógica compleja en un componente modal reutilizable (aunque implementado de forma separada en  y ). Este modal maneja la identificación de clientes/artículos, cálculo de deltas de precio y la interfaz para sustituir material o cambiar fechas.
-   **Búsqueda Inversa (Reverse Lookup)**: El endpoint  permite buscar un contrato activo a partir de un código de artículo o nombre de cliente, siendo la base del flujo Scan-to-Action.
-   **Reactividad de UI**: Se utiliza  extensivamente para recalcular estados derivados (como el balance económico de un cambio) cada vez que el usuario interactúa con el modal.

**key DB schema**
-   Sin cambios en la estructura de las colecciones.

**changes in tech stack**
-   Ninguno.

**All files of reference**
-   : Modificado para añadir el endpoint  y para enriquecer la respuesta de .
-   : Modificado masivamente para implementar la cabecera con el buscador inteligente, la vista compacta y el gestor de cambios.
-   : Modificado para añadir el botón GESTIONAR CAMBIO y para empezar a implementar el modal de gestión de contrato completo (trabajo en curso).
-   : Modificado y luego revertido a un estado anterior.
-   : Actualizado con las nuevas funcionalidades.

**Areas that need refactoring**:
-   **CRÍTICO:**  es un monolito que necesita ser dividido en módulos (routers, servicios) urgentemente.
-   **ALTO:** Los componentes  y  se han vuelto extremadamente complejos. Su lógica de estado y JSX debería descomponerse en hooks personalizados y sub-componentes más pequeños para mejorar la mantenibilidad.

**key api endpoints**
-   **Añadidos/Modificados:**
    -   : Procesa el cambio de artículos desde el gestor universal.
    -   : Realiza la búsqueda inversa por código o nombre.
    -   : Modificado para incluir  y  en la respuesta.

**Critical Info for New Agent**
-   **Prioridad Máxima:** La tarea inmediata es arreglar el botón GESTIONAR CAMBIO en la página de Devoluciones. Debes implementar un modal que gestione el contrato **completo** (múltiples artículos, cambio de fechas y material a la vez) y calcule el neto financiero.
-   **Iteración Rápida del Usuario:** El usuario a menudo solicita una funcionalidad, la ve implementada y luego pide una corrección o un cambio de enfoque (ej. el buscador global fue implementado y luego movido). Esté preparado para este ciclo de retroalimentación rápida.
-   **Componentes Complejos:**  y  son los archivos más complejos actualmente. Antes de modificar, es crucial entender cómo gestionan el estado de los modales y las interacciones del usuario.
-   **Fragilidad del Backend:**  es un único archivo muy grande. Edítelo con extrema precaución. La refactorización de este archivo sigue siendo una alta prioridad.

**documents and test reports created in this job**
-    (actualizado)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Pide implementar un botón CAMBIO / PRÓRROGA en la vista de Devoluciones.
2.  **Agent**: Implementa una primera versión del botón y el modal.
3.  **User**: Reporta un error ( is undefined) y pide ajustar el modal.
4.  **Agent**: Corrige el error añadiendo los datos faltantes al endpoint del backend.
5.  **User**: Pide un ajuste funcional mayor: el modal debe mostrar **todos** los artículos del contrato, no solo uno.
6.  **Agent**: Comienza a reescribir el modal para soportar múltiples artículos.
7.  **User**: Solicita una corrección integral del botón y la lógica. Renombrarlo a GESTIONAR CAMBIO y definir claramente todas las casuísticas (ampliación/reducción de días, upgrade/downgrade de material) y el flujo de caja obligatorio.
8.  **Agent**: Inicia la reescritura completa del estado y las funciones en  para cumplir con la nueva especificación.
9.  ... (El agente estaba en mitad de esta implementación cuando la sesión terminó).

**Project Health Check:**
-   **Broken**: No, las funcionalidades existentes son estables. Sin embargo, la última característica solicitada en la página de Devoluciones está a medio implementar y actualmente no funciona como se espera.
-   **Mocked**: , .

**3rd Party Integrations**
-   
-   , 

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: []
-   **Known regressions**: Ninguna.

**Credentials to test flow:**
-   Registra un nuevo usuario desde la interfaz de login (ej.  / ).

**What agent forgot to execute**
-   El agente no olvidó nada, sino que se quedó a mitad de la implementación de una tarea compleja: la reescritura del modal de GESTIONAR CAMBIO en . El código de estado y las funciones se han actualizado parcialmente, pero el JSX del modal y la lógica de cálculo del neto financiero aún no están completamente implementados.</analysis>
